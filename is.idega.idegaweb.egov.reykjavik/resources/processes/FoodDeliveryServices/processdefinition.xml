<?xml version="1.0" encoding="UTF-8"?>

<process-definition xmlns="" name="FoodDeliveryServices">
	<event type="process-start">
		<script>
			<expression>
				String handlerRoleName = "bpm_social_service_handler";
				String managerRoleName = "bpm_social_service_manager";
				String ownerRoleName = "bpm_social_service_owner";
				String caseHandlerRoleName = "bpm_social_service_caseHandler";
				String invitedRoleName = "bpm_social_service_invited";

				mainProcessInstanceId =	executionContext.getProcessInstance().getId();
			</expression>
			<variable name='mainProcessInstanceId' access='write' />
			<variable name='handlerRoleName' access='write' />
			<variable name='ownerRoleName' access='write' />
			<variable name='caseHandlerRoleName' access='write' />
			<variable name='invitedRoleName' access='write' />
			<variable name='managerRoleName' access='write' />
		</script>
	</event>
	<event type="process-start">
		<action class="com.idega.jbpm.proxy.JbpmHandlerProxy">
			<handlerName>rolesAssignmentHandler</handlerName>
			<propertyMap key-type='java.lang.String' value-type='java.lang.String'>
				<entry>
					<key>assignmentExpression</key>
					<value>
						${
						String handlerRoleName = resolver.get("handlerRoleName");
						String handlerNativeRoleName = handlerRoleName;
						String managerRoleName = resolver.get("managerRoleName");
						String managerNativeRoleName = managerRoleName;

						return "{rolesAssignment: {roles: {role: [" +
						" {roleName: \"" + handlerRoleName + "\", identities: {identity:[{identityType: ROLE, identityId: \"" + handlerNativeRoleName + "\"}]}}," +
						" {roleName: \"" + managerRoleName + "\", identities: {identity:[{identityType: ROLE, identityId: \"" + managerNativeRoleName + "\"}]}}" +
						" ]}}}";
						}
					</value>
				</entry>
			</propertyMap>
		</action>
	</event>
	<event type="process-start">
		<action class="com.idega.jbpm.proxy.JbpmHandlerProxy">
			<handlerName>rightsManagementRolesAssignmentHandler</handlerName>
			<propertyMap key-type='java.lang.String' value-type='java.lang.String'>
				<entry>
					<key>assignmentExpression</key>
					<value>
						{rightsAssignment: {roles: {role: [
							{roleName: "bpm_social_service_handler", accesses: {access:[modifyPermissions, caseHandler]}},
							{roleName: "bpm_social_service_handler", accesses: {access:[seeContacts]}, rolesContacts: {string: ["all"]}},
							{roleName: "bpm_social_service_manager", accesses: {access:[modifyPermissions]}},
							{roleName: "bpm_social_service_manager", accesses: {access:[seeContacts]}, rolesContacts: {string: ["all"]}},
							{roleName: "bpm_social_service_owner", accesses: {access: [seeContacts]}, rolesContacts: {string: ["bpm_social_service_manager"]}}
						]}}}
					</value>
				</entry>
			</propertyMap>
		</action>
	</event>
	<event type="handlerAssignedToCase">
		<action class="com.idega.jbpm.proxy.JbpmHandlerProxy">
			<handlerName>caseHandlerAssignmentHandler</handlerName>
			<propertyMap key-type='java.lang.String' value-type='java.lang.String'>
				<entry>
					<key>caseHandlerRoleExp</key>
					<value>{role: {roleName: "bpm_social_service_caseHandler"}}
					</value>
				</entry>
				<entry>
					<key>inlineSubject</key>
					<value>
						${
						Map subjectMap = new HashMap();
						subjectMap.put("en", "Handler was assigned to the case");
						subjectMap.put("is_IS", "Umsókn ({0}, {1}) í flokknum {2} hjá Lýðheilsusjóði hefur fengið umsjónarmann");
						return subjectMap;
						}
					</value>
				</entry>
				<entry>
					<key>inlineMessage</key>
					<value>
						${
						Map messageMap = new HashMap();
						messageMap.put("en", "Hi.\nHandler of the board of Lydheilsusjoður was assigned to the case {2} with identifier {3} and description {4}");
						messageMap.put("is_IS", "Sæl/ll.\nStjórn Lýðheilsusjóðs hefur tekið að sér umsóknina með nafnið : {4} ({3}) í flokknum : {2}.");
						return messageMap;
						}
					</value>
				</entry>
				<entry>
					<key>subjectValues</key>
					<value>
						{list: {mv: [
							{type: "bean", value: "piw.processDescription"}, 
							{type: "bean", value: "piw.processIdentifier"},
							{type: "bean", value: "piw.processDefinitionW.startTaskName"}
						]}}
					</value>
				</entry>
				<entry>
					<key>messageValues</key>
					<value>
						{list: {mv: [
							{type: "bean", value: "user.name"}, 
							{type: "roleUsers", value: "{role: {roleName: \"bpm_social_service_caseHandler\"}}"}, 
							{type: "bean", value: "piw.processDefinitionW.startTaskName"}, 
							{type: "bean", value: "piw.processIdentifier"}, 
							{type: "bean", value: "piw.processDescription"}
						]}}
					</value>
				</entry>
				<entry>
					<key>sendToRoles</key>
					<value>bpm_social_service_handler</value>
				</entry>
			</propertyMap>
		</action>
	</event>
	<event type="handlerUnassignedFromCase">
		<action class="com.idega.jbpm.proxy.JbpmHandlerProxy">
			<handlerName>caseHandlerAssignmentHandler</handlerName>
			<propertyMap key-type='java.lang.String' value-type='java.lang.String'>
				<entry>
					<key>caseHandlerRoleExp</key>
					<value>{role: {roleName: "bpm_social_service_caseHandler"}}
					</value>
				</entry>
				<entry>
					<key>inlineSubject</key>
					<value>
						${
						Map subjectMap = new HashMap();
						subjectMap.put("en", "Handler was unassigned from the case");
						subjectMap.put("is_IS", "Umsjónarmannaskipti á umsókn ({0}, {1})");
						return subjectMap;
						}

					</value>
				</entry>
				<entry>
					<key>inlineMessage</key>
					<value>
						${
						Map messageMap = new HashMap();
						messageMap.put("en", "Hi, {0}.\n Handler was unassigned from the case {1} with identifier {2} and description {3}");
						messageMap.put("is_IS", "Sæl/ll, {0}.\nUmsjónarmannaskipti hafa átt sér stað fyrir umsókn með nafnið: {3} ({2}) í flokknum {1}.");
						return messageMap;
						}
					</value>
				</entry>
				<entry>
					<key>subjectValues</key>
					<value>
						{list: {mv: [
							{type: "bean", value: "piw.processDescription"}, 
							{type: "bean", value: "piw.processIdentifier"}
						]}}
					</value>
				</entry>
				<entry>
					<key>messageValues</key>
					<value>
						{list: {mv: [
							{type: "bean", value: "user.name"}, 
							{type: "bean", value: "piw.processDefinitionW.startTaskName"}, 
							{type: "bean", value: "piw.processIdentifier"}, 
							{type: "bean", value: "piw.processDescription"}
						]}}
					</value>
				</entry>
				<entry>
					<key>sendToRoles</key>
					<value>bpm_social_service_handler</value>
				</entry>
			</propertyMap>
		</action>
	</event>
	<event type="postStartActivity">
		<action class="com.idega.jbpm.proxy.JbpmHandlerProxy">
			<handlerName>casesStatusHandler</handlerName>
			<propertyMap key-type='java.lang.String' value-type='java.lang.String'>
				<entry>
					<key>caseStatusMappedName</key>
					<value>caseStatusInProgress</value>
				</entry>
				<entry>
					<key>ifCaseStatusMappedName</key>
					<value>caseStatusOpened</value>
				</entry>
				<entry>
					<key>processInstanceId</key>
					<value>#{mainProcessInstanceId}</value>
				</entry>
			</propertyMap>
		</action>
	</event>

	<start-state name="submitNewCase">
		<task name="Submit New Case">
			<assignment class="com.idega.jbpm.proxy.JbpmHandlerProxy">
				<handlerName>jsonAssignmentHandler</handlerName>
				<propertyMap key-type='java.lang.String' value-type='java.lang.String'>
					<entry>
						<key>expression</key>
						<value>
							{taskAssignment: {roles: {role: [
								{roleName: "bpm_social_service_handler", accesses: {access: [read]}},
								{roleName: "bpm_social_service_owner", accesses: {access: [read, write]}, assignIdentities: {string: ["current_user"]}},
								{roleName: "bpm_social_service_manager", accesses: {access: [read]}},
								{roleName: "bpm_social_service_invited", accesses: {access: [read]}}
							]}}}
						</value>
					</entry>
				</propertyMap>
			</assignment>
			<controller>
				<!-- Main info -->
				<variable 
					name="string_caseDescription" 
					access="read,write"/>
				<variable 
					name="string_userName" 
					access="read,write,required"/>
				<variable
					name="string_userPersonalId"
					access="read,write,required" />
				<variable
					name="string_userAddress"
					access="read,write,required" />
				<variable
					name="string_userPostalCode"
					access="read,write,required" />
				<variable
					name="string_userPhone"
					access="read,write,required" />
				<variable
					name="string_userEmail"
					access="read,write,required" />
				
				<!-- closest relative -->
				<variable name="string_relativeName" access="read,write,required" />
				<variable name="string_relativePhone" access="read,write,required" />
				<variable name="string_relationship" access="read,write,required" />
				<!-- food wanted for the following days -->
				<variable name="list_deliveryDays" access="read,write,required" />
				<!-- diets -->
				<variable name="list_diets" access="read,write,required" />
				<!-- comments -->
				<variable name="string_foodDeliveryComments" access="read,write" />
				
				<variable 
					name="string_caseDescription" 
					access="read,write"/>
			</controller>
		</task>
		<transition to="defaultSocialService"></transition>
		<event type="node-leave">
			<action class="com.idega.jbpm.proxy.JbpmHandlerProxy">
				<handlerName>setProcessDescriptionHandler</handlerName>
			</action>
		</event>
	</start-state>

	<process-state name="defaultSocialService">
		<sub-process name="DefaultSocialServices" binding="late" />
		
		<!-- General data about process -->
		<variable
			name='mainProcessInstanceId'
			access='read'/>
		<variable 
			name="string_caseDescription" 
			access="read"/>
		<variable 
			name="string_caseIdentifier" 
			access="read"/>
			
		<!-- Roles -->
		<variable
			name='handlerRoleName'
			access='read' />
		<variable
			name='ownerRoleName'
			access='read' />
		<variable
			name='caseHandlerRoleName'
			access='read' />
		<variable
			name='invitedRoleName'
			access='read' />
		<variable
			name='managerRoleName'
			access='read' />
		
		<!-- Custom variables -->
		<variable
			name="string_userName"
			access="read"/>
		<variable
			name="string_userPersonalId"
			access="read" />
		<variable
			name="string_userEmail"
			access="read"/>
		<variable
			name="string_userPostalCode"
			access="read"/>
		<transition to="end-complete-process"></transition>
	</process-state>

	<end-state name="end-complete-process" end-complete-process="true"/>

	<idg:roles xmlns:idg="http://idega.com/bpm">
		<role name="bpm_social_service_caseHandler">
			<labels>
				<label lang="en">caseHandler</label>
				<label lang="is_IS">Umsjónarmaður</label>
			</labels>
		</role>
		<role name="bpm_social_service_handler" createNative="true">
			<labels>
				<label lang="en">handler</label>
				<label lang="is_IS">Umsjónarhópur</label>
			</labels>
		</role>
		<role name="bpm_social_service_invited">
			<labels>
				<label lang="en">invited</label>
				<label lang="is_IS">Þátttakendur</label>
			</labels>
		</role>
		<role name="bpm_social_service_owner">
			<labels>
				<label lang="en">owner</label>
				<label lang="is_IS">Sendandi</label>
			</labels>
		</role>
		<role name="bpm_social_service_manager" createNative="true">
			<labels>
				<label lang="en">manager</label>
				<label lang="is_IS">Verkefnastjóri</label>
			</labels>
		</role>
	</idg:roles>

</process-definition>