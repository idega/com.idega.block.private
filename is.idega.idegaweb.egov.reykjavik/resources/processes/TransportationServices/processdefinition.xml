<?xml version="1.0" encoding="UTF-8"?>

<process-definition xmlns="" name="TransportationServices">
	<event type="process-start">
		<script>
			<expression>
				String handlerRoleName = "bpm_social_service_handler";
				String managerRoleName = "bpm_social_service_manager";
				String ownerRoleName = "bpm_social_service_owner";
				String caseHandlerRoleName = "bpm_social_service_caseHandler";
				String invitedRoleName = "bpm_social_service_invited";

				mainProcessInstanceId =	executionContext.getProcessInstance().getId();
			</expression>
			<variable name='mainProcessInstanceId' access='write' />
			<variable name='handlerRoleName' access='write' />
			<variable name='ownerRoleName' access='write' />
			<variable name='caseHandlerRoleName' access='write' />
			<variable name='invitedRoleName' access='write' />
			<variable name='managerRoleName' access='write' />
		</script>
	</event>
	<event type="process-start">
		<action class="com.idega.jbpm.proxy.JbpmHandlerProxy">
			<handlerName>rolesAssignmentHandler</handlerName>
			<propertyMap key-type='java.lang.String' value-type='java.lang.String'>
				<entry>
					<key>assignmentExpression</key>
					<value>
						${
						String handlerRoleName = resolver.get("handlerRoleName");
						String handlerNativeRoleName = handlerRoleName;
						String managerRoleName = resolver.get("managerRoleName");
						String managerNativeRoleName = managerRoleName;

						return "{rolesAssignment: {roles: {role: [" +
						" {roleName: \"" + handlerRoleName + "\", identities: {identity:[{identityType: ROLE, identityId: \"" + handlerNativeRoleName + "\"}]}}," +
						" {roleName: \"" + managerRoleName + "\", identities: {identity:[{identityType: ROLE, identityId: \"" + managerNativeRoleName + "\"}]}}" +
						" ]}}}";
						}
					</value>
				</entry>
			</propertyMap>
		</action>
	</event>
	<event type="process-start">
		<action class="com.idega.jbpm.proxy.JbpmHandlerProxy">
			<handlerName>rightsManagementRolesAssignmentHandler</handlerName>
			<propertyMap key-type='java.lang.String' value-type='java.lang.String'>
				<entry>
					<key>assignmentExpression</key>
					<value>
						{rightsAssignment: {roles: {role: [
							{roleName: "bpm_social_service_handler", accesses: {access:[modifyPermissions, caseHandler]}},
							{roleName: "bpm_social_service_handler", accesses: {access:[seeContacts]}, rolesContacts: {string: ["all"]}},
							{roleName: "bpm_social_service_manager", accesses: {access:[modifyPermissions]}},
							{roleName: "bpm_social_service_manager", accesses: {access:[seeContacts]}, rolesContacts: {string: ["all"]}},
							{roleName: "bpm_social_service_owner", accesses: {access: [seeContacts]}, rolesContacts: {string: ["bpm_social_service_manager"]}}
						]}}}
					</value>
				</entry>
			</propertyMap>
		</action>
	</event>	
	<event type="postStartActivity">
		<action class="com.idega.jbpm.proxy.JbpmHandlerProxy">
			<handlerName>casesStatusHandler</handlerName>
			<propertyMap key-type='java.lang.String' value-type='java.lang.String'>
				<entry>
					<key>caseStatusMappedName</key>
					<value>caseStatusInProgress</value>
				</entry>
				<entry>
					<key>ifCaseStatusMappedName</key>
					<value>caseStatusOpened</value>
				</entry>
				<entry>
					<key>processInstanceId</key>
					<value>#{mainProcessInstanceId}</value>
				</entry>
			</propertyMap>
		</action>
	</event>

	<start-state name="submitNewCase">
		<task name="Submit New Case" >
			<assignment class="com.idega.jbpm.proxy.JbpmHandlerProxy">
				<handlerName>jsonAssignmentHandler</handlerName>
				<propertyMap key-type='java.lang.String' value-type='java.lang.String'>
					<entry>
						<key>expression</key>
						<value>
							{taskAssignment: {roles: {role: [
								{roleName: "bpm_social_service_handler", accesses: {access: [read]}},
								{roleName: "bpm_social_service_owner", accesses: {access: [read, write]}, assignIdentities: {string: ["current_user"]}},
								{roleName: "bpm_social_service_manager", accesses: {access: [read]}},
								{roleName: "bpm_social_service_invited", accesses: {access: [read]}}
							]}}}
						</value>
					</entry>
				</propertyMap>
			</assignment>
			<controller>
				<!-- Main info -->
				<variable 
					name="string_caseDescription" 
					access="read,write"/>
				<variable 
					name="string_userName" 
					access="read,write,required"/>
				<variable
					name="string_userPersonalId"
					access="read,write,required" />
				<variable
					name="string_userAddress"
					access="read,write,required" />
				<variable
					name="string_userPostalCode"
					access="read,write,required" />
				<variable
					name="string_userPhone"
					access="read,write,required" />
				<variable
					name="string_userEmail"
					access="read,write,required" />
			
				<variable name="string_caseDescription" access="read,write"></variable>
				<variable name="string_spouseName" access="read,write,required" />
			</controller>
		</task>
		<transition to="defaultSocialService"></transition>
		<event type="node-leave">
			<action class="com.idega.jbpm.proxy.JbpmHandlerProxy">
				<handlerName>setProcessDescriptionHandler</handlerName>
			</action>
		</event>
	</start-state>


	<process-state name="defaultSocialService">
		<sub-process name="DefaultSocialServices" binding="late" />
		<!-- General data about process -->
		<variable
			name='mainProcessInstanceId'
			access='read'/>
		<variable 
			name="string_caseDescription" 
			access="read"/>
		<variable 
			name="string_caseIdentifier" 
			access="read"/>
			
		<!-- Roles -->
		<variable
			name='handlerRoleName'
			access='read' />
		<variable
			name='ownerRoleName'
			access='read' />
		<variable
			name='caseHandlerRoleName'
			access='read' />
		<variable
			name='invitedRoleName'
			access='read' />
		<variable
			name='managerRoleName'
			access='read' />
		
		<!-- Custom variables -->
		<variable
			name="string_userName"
			access="read"/>
		<variable
			name="string_userPersonalId"
			access="read" />
		<variable
			name="string_userEmail"
			access="read"/>
		<variable
			name="string_userPostalCode"
			access="read"/>
		<transition to="end-complete-process"></transition>
	</process-state>

	<end-state name="end-complete-process" end-complete-process="true"/>

	<idg:roles xmlns:idg="http://idega.com/bpm">
		<role name="bpm_social_service_caseHandler">
			<labels>
				<label lang="en">caseHandler</label>
				<label lang="is_IS">Umsjónarmaður</label>
			</labels>
		</role>
		<role name="bpm_social_service_handler" createNative="true">
			<labels>
				<label lang="en">handler</label>
				<label lang="is_IS">Umsjónarhópur</label>
			</labels>
		</role>
		<role name="bpm_social_service_invited">
			<labels>
				<label lang="en">invited</label>
				<label lang="is_IS">Þátttakendur</label>
			</labels>
		</role>
		<role name="bpm_social_service_owner">
			<labels>
				<label lang="en">owner</label>
				<label lang="is_IS">Sendandi</label>
			</labels>
		</role>
		<role name="bpm_social_service_manager" createNative="true">
			<labels>
				<label lang="en">manager</label>
				<label lang="is_IS">Verkefnastjóri</label>
			</labels>
		</role>
	</idg:roles>

</process-definition>